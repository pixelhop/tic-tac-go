<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useIntervalFn } from '@vueuse/core';
import dayjs from 'dayjs';
import { computed, ref } from 'vue';
import Modal from '../Modal.vue';
import Player from '../Player.vue';
import Score from '../Score.vue';
import { useGameStore } from '../../stores/game';
import IconConfetti from '../IconConfetti.vue';

const store = useGameStore();
const { game, player1Name, player2Name } = storeToRefs(store);

const roundWinner = computed(() => game.value.roundWinners[game.value.round - 1]);
const winnerName = computed(() => (roundWinner.value === 1 ? player1Name.value : player2Name.value));

const secondsRemaining = ref(1000);
useIntervalFn(() => {
  secondsRemaining.value = dayjs(game.value.roundStartTime).diff(dayjs(), 'seconds');
}, 100);
</script>

<template>
  <Modal title="Round winner">
    <div class="h-full flex flex-col items-center justify-between relative">
      <div v-if="roundWinner" class="h-2/3 flex items-center justify-center relative">
        <IconConfetti :player="roundWinner" />

        <svg class="cup" width="169" height="169" viewBox="0 0 169 169" fill="none" xmlns="http://www.w3.org/2000/svg">
          <g filter="url(#filter0_d_706_847)">
            <path
              d="M150.995 43.3795C150.863 32.0914 145.086 25.8745 134.729 25.8745C130.72 25.8745 126.857 26.8075 124.332 27.5861C124.584 22.9721 124.588 20.124 124.588 19.9825L124.588 18.0072H44.4136V19.9822C44.4136 20.0497 44.4204 22.9427 44.6747 27.5884C42.1498 26.8094 38.2834 25.8745 34.2708 25.8745C23.914 25.8745 18.137 32.0912 18.0045 43.3795C17.8741 54.4845 20.4069 64.3696 25.5318 72.7609C30.5634 80.9993 36.9947 85.9637 41.504 88.677C48.7262 93.0234 55.9444 93.9356 60.7282 93.9356C61.9075 93.9356 63.0437 93.8801 64.1064 93.7704C64.1768 93.7632 64.242 93.7548 64.3109 93.7473C66.6238 96.2382 69.1173 98.2335 71.7817 99.7162C73.7458 100.809 75.1119 102.715 75.58 104.906C72.9317 105.73 71.0035 108.204 71.0035 111.12C71.0035 114.101 73.02 116.619 75.7598 117.385V125.675H65.0725V134.325H54.526V150.993H114.475V134.325H103.929V125.675H93.2412V117.385C95.9812 116.619 97.9978 114.101 97.9978 111.12C97.9978 108.204 96.0696 105.73 93.4212 104.906C93.8893 102.715 95.2552 100.809 97.2195 99.7162C99.8775 98.2374 102.388 96.2312 104.695 93.7484C105.513 93.839 106.739 93.9354 108.271 93.9354C108.272 93.9354 108.272 93.9354 108.272 93.9354C113.056 93.9354 120.273 93.0226 127.495 88.6767C132.004 85.9632 138.436 80.9991 143.467 72.7606C148.593 64.3697 151.126 54.4843 150.995 43.3795ZM120.605 21.9572C120.588 22.6796 120.559 23.5877 120.516 24.6507H48.493C48.4483 23.588 48.4184 22.6786 48.3992 21.9572H120.605ZM123.292 40.0922C125.968 39.2015 129.436 38.3032 132.543 38.3032C135.148 38.3032 137.024 38.9396 138.119 40.1948C139.376 41.6376 139.782 44.0612 139.323 47.3992C137.413 61.3034 131.384 72.1569 122.346 77.9598C119.198 79.9813 115.808 80.8164 112.967 81.1131C118.977 68.4804 121.886 52.6306 123.292 40.0922ZM47.7417 53.8502C49.6845 64.2707 52.3669 73.2191 55.7147 80.4465C55.8184 80.671 55.9238 80.892 56.0288 81.1131C53.1885 80.8157 49.8001 79.9808 46.6533 77.9603C37.6158 72.1572 31.5866 61.3039 29.6766 47.3997C29.2181 44.0614 29.6233 41.6376 30.8814 40.1953C31.9758 38.9402 33.8518 38.304 36.4567 38.304C39.5664 38.304 43.0379 39.2036 45.715 40.0948C46.1933 44.3711 46.8471 49.0518 47.7417 53.8502ZM60.7282 89.9856C56.4452 89.9856 49.9861 89.1713 43.5411 85.2927C36.9495 81.3261 21.6506 69.3057 21.9545 43.426C22.0621 34.2737 26.0908 29.8247 34.2708 29.8247C38.6455 29.8247 42.9662 31.1435 44.9412 31.8392C45.0397 33.1643 45.1501 34.4932 45.2721 35.8167C42.5875 35.0281 39.4243 34.3532 36.4567 34.3532C32.6595 34.3532 29.7821 35.445 27.904 37.5985C25.8625 39.9397 25.1421 43.418 25.763 47.9366C26.8264 55.6779 29.049 62.5201 32.3691 68.2729C35.5385 73.7649 39.6264 78.1424 44.5188 81.2835C49.2975 84.3521 54.466 85.126 58.1529 85.2C58.1653 85.2218 58.1781 85.2426 58.1905 85.2642C58.3926 85.6182 58.5968 85.9663 58.8031 86.31C58.8672 86.4173 58.9319 86.5238 58.9966 86.63C59.1932 86.9531 59.3914 87.2732 59.5917 87.5867C59.6671 87.7046 59.7434 87.8197 59.8193 87.9366C59.9557 88.1462 60.0928 88.3541 60.231 88.5595C60.3645 88.7583 60.4986 88.9549 60.6334 89.1495C60.7656 89.3399 60.8981 89.5292 61.0316 89.716C61.0942 89.8038 61.1558 89.895 61.2184 89.9817C61.0594 89.9843 60.896 89.9856 60.7282 89.9856ZM110.525 138.276V147.043H58.4765V138.276H65.0728H103.929H110.525ZM93.2418 129.625H99.9785V134.325H69.023V129.625H75.76H93.2418ZM79.71 125.675V117.627H89.2915V125.675H79.71ZM94.0481 111.12C94.0481 112.53 92.9009 113.677 91.4915 113.677H77.5104C76.1006 113.677 74.9537 112.53 74.9537 111.12C74.9537 109.71 76.1006 108.563 77.5104 108.563H91.4915C92.9012 108.563 94.0481 109.71 94.0481 111.12ZM103.928 88.5401C103.906 88.5684 103.884 88.5967 103.863 88.625C103.668 88.8764 103.472 89.1217 103.275 89.3635C103.227 89.4225 103.18 89.4825 103.131 89.5412C102.915 89.8041 102.696 90.0612 102.477 90.3122C102.467 90.3241 102.457 90.3366 102.446 90.3485C100.243 92.8613 97.8391 94.8513 95.2994 96.2644C92.1689 98.0059 90.0404 101.099 89.4549 104.613H79.5469C78.9611 101.099 76.8326 98.0059 73.7022 96.2644C71.251 94.9009 69.0373 93.0782 67.0374 90.9L66.5542 90.3488C64.5904 88.1091 62.7393 85.3956 61.0526 82.2844L60.536 81.3308C52.0424 64.9196 49.4733 41.2001 48.6987 28.6007H120.317C120.284 29.1488 120.248 29.7148 120.208 30.3027C120.206 30.33 120.204 30.358 120.203 30.3853C120.159 31.0222 120.112 31.661 120.063 32.3003C120.061 32.319 120.06 32.3377 120.058 32.3567C119.9 34.3828 119.713 36.4165 119.5 38.4261L119.371 39.6413C117.936 52.5069 114.905 68.8974 108.513 81.2435L107.948 82.2841C106.692 84.6002 105.345 86.6955 103.928 88.5401ZM125.459 85.2927C119.013 89.1715 112.556 89.9856 108.273 89.9856C108.273 89.9856 108.272 89.9856 108.272 89.9856C108.104 89.9856 107.94 89.9843 107.781 89.9817C107.784 89.9781 107.786 89.9742 107.789 89.9706C108.045 89.6168 108.298 89.2578 108.546 88.8939C108.577 88.8494 108.607 88.804 108.637 88.7596C108.847 88.4499 109.054 88.1361 109.259 87.8192C109.312 87.7379 109.364 87.6563 109.417 87.5745C109.643 87.2189 109.867 86.8609 110.087 86.4967C110.122 86.4398 110.155 86.3814 110.189 86.324C110.369 86.0232 110.547 85.7195 110.723 85.413C110.764 85.3413 110.806 85.2727 110.848 85.2005C114.534 85.1265 119.703 84.3526 124.482 81.284C129.374 78.1424 133.462 73.7649 136.631 68.2734C139.951 62.5206 142.174 55.6784 143.238 47.9371C143.858 43.4183 143.138 39.94 141.097 37.599C139.219 35.4453 136.341 34.3535 132.544 34.3535C129.576 34.3535 126.413 35.0278 123.728 35.8167C123.853 34.4672 123.96 33.1728 124.051 31.9426C124.054 31.9083 124.056 31.8737 124.059 31.8397C126.035 31.1438 130.355 29.8252 134.729 29.8252C142.909 29.8252 146.938 34.2742 147.046 43.426C147.349 69.3057 132.05 81.3258 125.459 85.2927Z"
              fill="white"
            />
            <path
              d="M67.9675 81.9639L64.6685 84.1374C65.7948 85.8474 67.0053 87.4011 68.2665 88.755L71.1571 86.0622C70.0461 84.8697 68.973 83.4906 67.9675 81.9639Z"
              fill="white"
            />
            <path
              d="M59.4887 60.0618L55.6375 60.9403C57.5317 69.2437 60.0605 76.2143 63.1532 81.6582L66.5879 79.7068C63.6858 74.5985 61.2972 67.989 59.4887 60.0618Z"
              fill="white"
            />
            <path
              d="M133.249 104.634L133.246 100.684L129.912 100.686L129.909 97.3514L125.959 97.354L125.962 100.689L122.627 100.691L122.63 104.641L125.964 104.639L125.967 107.973L129.917 107.971L129.914 104.636L133.249 104.634Z"
              fill="white"
            />
            <path
              d="M47.2977 125.147L47.2935 121.197L44.4953 121.199L44.4925 118.401L40.5422 118.405L40.5451 121.203L37.7463 121.206L37.7508 125.156L40.5489 125.154L40.5518 127.952L44.5021 127.948L44.4992 125.15L47.2977 125.147Z"
              fill="white"
            />
            <path d="M34.4146 92.8543H30.6882V96.8046H34.4146V92.8543Z" fill="white" />
            <path d="M58.3635 104.542H54.6372V108.492H58.3635V104.542Z" fill="white" />
            <path d="M118.425 116.426H114.699V120.377H118.425V116.426Z" fill="white" />
          </g>
          <defs>
            <filter
              id="filter0_d_706_847"
              x="-0.000244141"
              y="0.00720215"
              width="169"
              height="168.986"
              filterUnits="userSpaceOnUse"
              color-interpolation-filters="sRGB"
            >
              <feFlood flood-opacity="0" result="BackgroundImageFix" />
              <feColorMatrix
                in="SourceAlpha"
                type="matrix"
                values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                result="hardAlpha"
              />
              <feOffset />
              <feGaussianBlur stdDeviation="9" />
              <feComposite in2="hardAlpha" operator="out" />
              <feColorMatrix type="matrix" values="0 0 0 0 0.00784314 0 0 0 0 1 0 0 0 0 1 0 0 0 0.53 0" />
              <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_706_847" />
              <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_706_847" result="shape" />
            </filter>
          </defs>
        </svg>
      </div>

      <Player v-if="roundWinner" class="-ml-4" :name="winnerName" :player="roundWinner" orientation="left" />

      <div v-if="!roundWinner" class="h-full flex items-center">
        <h2 class="text-6xl text-white uppercase">Round Draw</h2>
      </div>

      <Score />
    </div>
  </Modal>
</template>

<style scoped>
.winner-icon,
.winner-icon-container {
  transform-origin: center center;
}

.cup {
  animation-name: cupAnimation;
  animation-duration: 400ms;
  animation-fill-mode: both;
  animation-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
  animation-delay: 1s;
}

@keyframes cupAnimation {
  from {
    opacity: 0;
    transform: scale(0);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
</style>
